<body>
    <div class="container">
     
        
        <form id="paymentForm">
            <div class="form-group">
                <label for="userId">ç”¨æˆ·ID:</label>
                <input type="text" id="userId" value="123" required>
            </div>
            
            <div class="form-group">
                <label for="amount">æ”¯ä»˜é‡‘é¢ (å…ƒ):</label>
                <input type="number" id="amount" value="0.01" step="0.01" min="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="courseId">è¯¾ç¨‹ID:</label>
                <input type="number" id="courseId" value="1001" required>
            </div>
            
            <div class="form-group">
                <label for="courseName">è¯¾ç¨‹åç§°:</label>
                <input type="text" id="courseName" value="æµ‹è¯•è¯¾ç¨‹" required>
            </div>
            
            <div class="form-group">
                <label for="token">JWT Token (å¯é€‰):</label>
                <input type="text" id="token" placeholder="Bearer xxx...">
                <small>å¦‚æœä¸å¡«å†™ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿtokenè¿›è¡Œæµ‹è¯•</small>
            </div>
        </form>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div id="orderInfo" class="order-info" style="display: none;">
            <h3>ğŸ“‹ è®¢å•ä¿¡æ¯</h3>
            <p><strong>è®¢å•å·:</strong> <span id="generatedOrderId">-</span></p>
            <p><strong>ç”¨æˆ·ID:</strong> <span id="orderUserId">-</span></p>
            <p><strong>æ”¯ä»˜é‡‘é¢:</strong> Â¥<span id="orderAmount">-</span></p>
            <p><strong>è¯¾ç¨‹ä¿¡æ¯:</strong> <span id="orderCourseInfo">-</span></p>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button id="createPaymentBtn" class="button" onclick="createPayment()">
                åˆ›å»ºæ”¯ä»˜è®¢å•
            </button>
            <button id="testNotifyBtn" class="button" onclick="testNotify()" style="background: #52c41a;">
                æµ‹è¯•å¼‚æ­¥é€šçŸ¥
            </button>
            <button id="testCancelBtn" class="button" onclick="testCancel()" style="background: #fa8c16;">
                æµ‹è¯•å–æ¶ˆè®¢å•
            </button>
            <button id="testRefundBtn" class="button" onclick="testRefund()" style="background: #eb2f96;">
                æµ‹è¯•é€€æ¬¾
            </button>
            <button id="queryOrderBtn" class="button" onclick="queryOrder()" style="background: #722ed1;">
                æŸ¥è¯¢è®¢å•çŠ¶æ€
            </button>
        </div>
        
        <div id="paymentFormContainer" style="margin-top: 30px; display: none;">
            <h3>æ”¯ä»˜è¡¨å•:</h3>
            <div id="paymentFormHtml"></div>
        </div>
    </div>

    <script>
        let currentOrderId = null; // å­˜å‚¨å½“å‰åˆ›å»ºçš„è®¢å•å·
        
        // åˆ›å»ºæ”¯ä»˜è®¢å•
        async function createPayment() {
            const statusDiv = document.getElementById('status');
            const createBtn = document.getElementById('createPaymentBtn');
            const orderInfoDiv = document.getElementById('orderInfo');
            
            try {
                statusDiv.style.display = 'block';
                statusDiv.className = 'status loading';
                statusDiv.innerHTML = '<p>ğŸ”„ æ­£åœ¨åˆ›å»ºæ”¯ä»˜è®¢å•...</p>';
                createBtn.disabled = true;
                createBtn.textContent = 'åˆ›å»ºä¸­...';
                
                // è·å–è¡¨å•æ•°æ®ï¼ˆä¸åŒ…å«è®¢å•å·ï¼Œç”±åç«¯ç”Ÿæˆï¼‰
                const orderData = {
                    userId: document.getElementById('userId').value,
                    paymentPrice: parseFloat(document.getElementById('amount').value),
                    paymentType: "alipay",
                    orderItemList: [
                        {
                            courseId: parseInt(document.getElementById('courseId').value),
                            courseName: document.getElementById('courseName').value,
                            currentPrice: parseFloat(document.getElementById('amount').value),
                            courseOriginalPrice: parseFloat(document.getElementById('amount').value),
                            courseDiscount: 1
                        }
                    ]
                };
                
                console.log('åˆ›å»ºæ”¯ä»˜è®¢å•ï¼Œæ•°æ®:', orderData);
                
                // è°ƒç”¨åç«¯APIåˆ›å»ºæ”¯ä»˜è®¢å•
                const response = await fetch('https://itie.sumixer.com/api/api/pay/alipay/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });
                
                console.log('å“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('åç«¯å“åº”:', result);
                
                if (result.status === 1202 && result.data) {
                    // ä»è¿”å›çš„è®¢å•ä¿¡æ¯ä¸­è·å–ç”Ÿæˆçš„è®¢å•å·
                    if (result.data.orderId) {
                        currentOrderId = result.data.orderId;
                        
                        // æ˜¾ç¤ºè®¢å•ä¿¡æ¯
                        document.getElementById('generatedOrderId').textContent = currentOrderId;
                        document.getElementById('orderUserId').textContent = orderData.userId;
                        document.getElementById('orderAmount').textContent = orderData.paymentPrice;
                        document.getElementById('orderCourseInfo').textContent = `${orderData.orderItemList[0].courseName} (ID: ${orderData.orderItemList[0].courseId})`;
                        orderInfoDiv.style.display = 'block';
                    }
                    
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = '<p>âœ… æ”¯ä»˜è®¢å•åˆ›å»ºæˆåŠŸï¼</p><p>è®¢å•å·²ä¿å­˜åˆ°æ•°æ®åº“ï¼Œå¯ä»¥ç»§ç»­æµ‹è¯•å…¶ä»–åŠŸèƒ½</p>';
                    createBtn.textContent = 'åˆ›å»ºæˆåŠŸ';

                    // è‡ªåŠ¨è·³è½¬åˆ°æ”¯ä»˜å®æ”¯ä»˜é¡µé¢
                    if (result.data.formHtml) {
                        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶divæ’å…¥formHtml
                        const tempDiv = document.createElement('div');
                        tempDiv.style.display = 'none';
                        tempDiv.innerHTML = result.data.formHtml;
                        document.body.appendChild(tempDiv);
                        // è‡ªåŠ¨æäº¤è¡¨å•
                        const form = tempDiv.querySelector('form');
                        if (form) {
                            form.submit();
                        } else {
                            alert('æœªè·å–åˆ°æ”¯ä»˜è¡¨å•ï¼Œæ— æ³•è·³è½¬');
                        }
                    }
                    // ä¸å†æ˜¾ç¤ºæ”¯ä»˜è¡¨å•ï¼Œå› ä¸ºç°åœ¨è¿”å›çš„æ˜¯è®¢å•ä¿¡æ¯
                    // å¦‚æœéœ€è¦çœŸå®æ”¯ä»˜ï¼Œå¯ä»¥è°ƒç”¨æ”¯ä»˜å®çš„æ”¯ä»˜æ¥å£
                    
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `<p>âŒ åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥: ${result.message}</p>`;
                    createBtn.textContent = 'åˆ›å»ºå¤±è´¥';
                }
                
            } catch (error) {
                console.error('åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `<p>âŒ åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥: ${error.message}</p>`;
                createBtn.textContent = 'åˆ›å»ºå¤±è´¥';
            } finally {
                createBtn.disabled = false;
            }
        }
        
        // æµ‹è¯•å¼‚æ­¥é€šçŸ¥
        async function testNotify() {
            const statusDiv = document.getElementById('status');
            const notifyBtn = document.getElementById('testNotifyBtn');
            
            if (!currentOrderId) {
                statusDiv.style.display = 'block';
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '<p>âŒ è¯·å…ˆåˆ›å»ºæ”¯ä»˜è®¢å•</p>';
                return;
            }
            
            try {
                statusDiv.style.display = 'block';
                statusDiv.className = 'status loading';
                statusDiv.innerHTML = '<p>ğŸ”„ æ­£åœ¨æµ‹è¯•å¼‚æ­¥é€šçŸ¥...</p>';
                notifyBtn.disabled = true;
                notifyBtn.textContent = 'æµ‹è¯•ä¸­...';
                
                // æ„é€ æ¨¡æ‹Ÿçš„æ”¯ä»˜å®å›è°ƒå‚æ•°
                const mockParams = `out_trade_no=${currentOrderId}&trade_no=2024122600000000&trade_status=TRADE_SUCCESS&total_amount=${document.getElementById('amount').value}&buyer_id=2088102122458832&app_id=9021000149688581&sign_type=RSA2&timestamp=2024-12-26+11:18:54&version=1.0&sign=test_real_sign`;
                
                console.log('æµ‹è¯•å¼‚æ­¥é€šçŸ¥ï¼Œå‚æ•°:', mockParams);
                
                // è°ƒç”¨åç«¯é€šçŸ¥æ¥å£
                const response = await fetch('https://itie.sumixer.com/api/api/pay/alipay/notify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `params=${encodeURIComponent(mockParams)}`
                });
                
                const result = await response.json();
                console.log('å¼‚æ­¥é€šçŸ¥æµ‹è¯•ç»“æœ:', result);
                
                if (result.status === 1) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = '<p>âœ… å¼‚æ­¥é€šçŸ¥æµ‹è¯•æˆåŠŸï¼è®¢å•çŠ¶æ€å·²æ›´æ–°ï¼Œè¯¾ç¨‹å·²æ·»åŠ åˆ°ç”¨æˆ·è¯¾ç¨‹è¡¨</p>';
                    notifyBtn.textContent = 'æµ‹è¯•æˆåŠŸ';
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `<p>âŒ å¼‚æ­¥é€šçŸ¥æµ‹è¯•å¤±è´¥: ${result.message}</p>`;
                    notifyBtn.textContent = 'æµ‹è¯•å¤±è´¥';
                }
                
            } catch (error) {
                console.error('å¼‚æ­¥é€šçŸ¥æµ‹è¯•å¤±è´¥:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `<p>âŒ å¼‚æ­¥é€šçŸ¥æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
                notifyBtn.textContent = 'æµ‹è¯•å¤±è´¥';
            } finally {
                notifyBtn.disabled = false;
            }
        }
        
        // æµ‹è¯•å–æ¶ˆè®¢å•
        async function testCancel() {
            const statusDiv = document.getElementById('status');
            const cancelBtn = document.getElementById('testCancelBtn');
            
            if (!currentOrderId) {
                statusDiv.style.display = 'block';
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '<p>âŒ è¯·å…ˆåˆ›å»ºæ”¯ä»˜è®¢å•</p>';
                return;
            }
            
            try {
                statusDiv.style.display = 'block';
                statusDiv.className = 'status loading';
                statusDiv.innerHTML = '<p>ğŸ”„ æ­£åœ¨æµ‹è¯•å–æ¶ˆè®¢å•...</p>';
                cancelBtn.disabled = true;
                cancelBtn.textContent = 'æµ‹è¯•ä¸­...';
                
                console.log('æµ‹è¯•å–æ¶ˆè®¢å•ï¼Œè®¢å•ID:', currentOrderId);
                
                // è°ƒç”¨åç«¯å–æ¶ˆæ¥å£
                const response = await fetch(`https://itie.sumixer.com/api/api/pay/alipay/cancel?orderId=${currentOrderId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                console.log('å–æ¶ˆè®¢å•æµ‹è¯•ç»“æœ:', result);
                
                if (result.status === 1) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = '<p>âœ… å–æ¶ˆè®¢å•æµ‹è¯•æˆåŠŸï¼</p>';
                    cancelBtn.textContent = 'æµ‹è¯•æˆåŠŸ';
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `<p>âŒ å–æ¶ˆè®¢å•æµ‹è¯•å¤±è´¥: ${result.message}</p>`;
                    cancelBtn.textContent = 'æµ‹è¯•å¤±è´¥';
                }
                
            } catch (error) {
                console.error('å–æ¶ˆè®¢å•æµ‹è¯•å¤±è´¥:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `<p>âŒ å–æ¶ˆè®¢å•æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
                cancelBtn.textContent = 'æµ‹è¯•å¤±è´¥';
            } finally {
                cancelBtn.disabled = false;
            }
        }
        
        // æµ‹è¯•é€€æ¬¾
        async function testRefund() {
            const statusDiv = document.getElementById('status');
            const refundBtn = document.getElementById('testRefundBtn');
            
            if (!currentOrderId) {
                statusDiv.style.display = 'block';
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '<p>âŒ è¯·å…ˆåˆ›å»ºæ”¯ä»˜è®¢å•</p>';
                return;
            }
            
            try {
                statusDiv.style.display = 'block';
                statusDiv.className = 'status loading';
                statusDiv.innerHTML = '<p>ğŸ”„ æ­£åœ¨æµ‹è¯•é€€æ¬¾...</p>';
                refundBtn.disabled = true;
                refundBtn.textContent = 'æµ‹è¯•ä¸­...';
                
                console.log('æµ‹è¯•é€€æ¬¾ï¼Œè®¢å•ID:', currentOrderId);
                
                // è°ƒç”¨åç«¯é€€æ¬¾æ¥å£
                const response = await fetch(`https://itie.sumixer.com/api/api/pay/alipay/refund?orderId=${currentOrderId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                console.log('é€€æ¬¾æµ‹è¯•ç»“æœ:', result);
                
                if (result.status === 1) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `<p>âœ… é€€æ¬¾æµ‹è¯•æˆåŠŸï¼</p><p>${result.data}</p>`;
                    refundBtn.textContent = 'æµ‹è¯•æˆåŠŸ';
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `<p>âŒ é€€æ¬¾æµ‹è¯•å¤±è´¥: ${result.message}</p>`;
                    refundBtn.textContent = 'æµ‹è¯•å¤±è´¥';
                }
                
            } catch (error) {
                console.error('é€€æ¬¾æµ‹è¯•å¤±è´¥:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `<p>âŒ é€€æ¬¾æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
                refundBtn.textContent = 'æµ‹è¯•å¤±è´¥';
            } finally {
                refundBtn.disabled = false;
            }
        }
        
        // æŸ¥è¯¢è®¢å•çŠ¶æ€
        async function queryOrder() {
            const statusDiv = document.getElementById('status');
            const queryBtn = document.getElementById('queryOrderBtn');
            
            if (!currentOrderId) {
                statusDiv.style.display = 'block';
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '<p>âŒ è¯·å…ˆåˆ›å»ºæ”¯ä»˜è®¢å•</p>';
                return;
            }
            
            try {
                statusDiv.style.display = 'block';
                statusDiv.className = 'status loading';
                statusDiv.innerHTML = '<p>ğŸ”„ æ­£åœ¨æŸ¥è¯¢è®¢å•çŠ¶æ€...</p>';
                queryBtn.disabled = true;
                queryBtn.textContent = 'æŸ¥è¯¢ä¸­...';
                
                console.log('æŸ¥è¯¢è®¢å•çŠ¶æ€ï¼Œè®¢å•ID:', currentOrderId);
                // è°ƒç”¨åç«¯æŸ¥è¯¢æ¥å£
                //
                const response = await fetch(`https://itie.sumixer.com/api/order/single/${currentOrderId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                console.log('è®¢å•æŸ¥è¯¢ç»“æœ:', result);
                
                if (result.status === 1) {
                    const order = result.data;
                    const statusText = getStatusText(order.status);
                    const paymentTime = order.paymentTime ? new Date(order.paymentTime).toLocaleString() : 'æœªæ”¯ä»˜';
                    const currentTime = new Date().toLocaleString();
                    
                    // è®¡ç®—æ—¶é—´å·®
                    let timeInfo = '';
                    if (order.paymentTime) {
                        const timeDiff = Date.now() - new Date(order.paymentTime).getTime();
                        const hoursDiff = Math.floor(timeDiff / (60 * 60 * 1000));
                        const minutesDiff = Math.floor((timeDiff % (60 * 60 * 1000)) / (60 * 1000));
                        
                        if (hoursDiff < 24) {
                            timeInfo = `<p>âœ… è·ç¦»æ”¯ä»˜æ—¶é—´: ${hoursDiff}å°æ—¶${minutesDiff}åˆ†é’Ÿ (å¯é€€æ¬¾)</p>`;
                        } else {
                            timeInfo = `<p>âŒ è·ç¦»æ”¯ä»˜æ—¶é—´: ${hoursDiff}å°æ—¶${minutesDiff}åˆ†é’Ÿ (è¶…è¿‡24å°æ—¶ï¼Œä¸å¯é€€æ¬¾)</p>`;
                        }
                    }
                    
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `
                        <p>âœ… è®¢å•æŸ¥è¯¢æˆåŠŸï¼</p>
                        <p><strong>è®¢å•ä¿¡æ¯:</strong></p>
                        <p>è®¢å•ID: ${order.orderId}</p>
                        <p>è®¢å•çŠ¶æ€: ${statusText}</p>
                        <p>æ”¯ä»˜é‡‘é¢: Â¥${order.paymentPrice || 0}</p>
                        <p>æ”¯ä»˜æ—¶é—´: ${paymentTime}</p>
                        <p>å½“å‰æ—¶é—´: ${currentTime}</p>
                        ${timeInfo}
                    `;
                    queryBtn.textContent = 'æŸ¥è¯¢æˆåŠŸ';
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `<p>âŒ è®¢å•æŸ¥è¯¢å¤±è´¥: ${result.message}</p>`;
                    queryBtn.textContent = 'æŸ¥è¯¢å¤±è´¥';
                }
                
            } catch (error) {
                console.error('è®¢å•æŸ¥è¯¢å¤±è´¥:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `<p>âŒ è®¢å•æŸ¥è¯¢å¤±è´¥: ${error.message}</p>`;
                queryBtn.textContent = 'æŸ¥è¯¢å¤±è´¥';
            } finally {
                queryBtn.disabled = false;
            }
        }
        
        // è·å–è®¢å•çŠ¶æ€æ–‡æœ¬æè¿°
        function getStatusText(status) {
            switch (status) {
                case 1: return "å·²å–æ¶ˆ";
                case 2: return "æœªæ”¯ä»˜";
                case 3: return "å·²æ”¯ä»˜";
                case 4: return "å·²é€€æ¬¾";
                default: return "æœªçŸ¥çŠ¶æ€";
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            console.log('æ”¯ä»˜æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            console.log('åç«¯APIåœ°å€: http://localhost:8080');
            console.log('æ”¯ä»˜å®ç½‘å…³: https://openapi.alipay.com/gateway.do');
            console.log('è®¢å•å·ç”±åç«¯è‡ªåŠ¨ç”Ÿæˆ');
        };
    </script>
</body>
</html> 